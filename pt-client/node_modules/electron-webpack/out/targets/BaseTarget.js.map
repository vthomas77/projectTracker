{"version":3,"sources":["../../src/targets/BaseTarget.ts"],"names":[],"mappings":"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","sourcesContent":["import * as path from \"path\"\nimport { DefinePlugin, EnvironmentPlugin, HotModuleReplacementPlugin, LoaderOptionsPlugin } from \"webpack\"\nimport { configureDll } from \"../configurators/dll\"\nimport { configureEslint } from \"../configurators/eslint\"\nimport { createBabelLoader } from \"../configurators/js\"\nimport { WebpackConfigurator } from \"../main\"\nimport { WatchFilterPlugin } from \"../plugins/WatchMatchPlugin\"\nimport { WebpackRemoveOldAssetsPlugin } from \"../plugins/WebpackRemoveOldAssetsPlugin\"\n\nexport class BaseTarget {\n  configureRules(configurator: WebpackConfigurator): void {\n    const rules = configurator.rules\n\n    const babelLoader = createBabelLoader(configurator)\n    if (configurator.type !== \"main\" && configurator.hasDependency(\"iview\")) {\n      rules.push({\n        test: /iview.src.*?js$/,\n        use: babelLoader\n      })\n    }\n\n    rules.push(\n      {\n        test: /\\.js$/,\n        exclude: /(node_modules|bower_components)/,\n        use: babelLoader\n      },\n      {\n        test: /\\.node$/,\n        use: \"node-loader\"\n      },\n    )\n\n    if (configurator.hasDevDependency(\"nunjucks-loader\")) {\n      rules.push({\n        test: /\\.(njk|nunjucks)$/,\n        loader: \"nunjucks-loader\"\n      })\n    }\n\n    configureEslint(configurator)\n  }\n\n  async configurePlugins(configurator: WebpackConfigurator): Promise<void> {\n    const plugins = configurator.plugins\n\n    const dllManifest = await configureDll(configurator)\n    const mode = configurator.isProduction ? \"production\" : \"development\"\n\n    let optimization = configurator.config.optimization\n    if (optimization == null) {\n      optimization = {}\n      configurator.config.optimization = optimization\n    }\n\n    optimization.nodeEnv = mode\n    configurator.config.mode = mode\n\n    if (configurator.isProduction) {\n      if (configurator.env.minify !== false) {\n        const UglifyJsPlugin = require(\"uglifyjs-webpack-plugin\")\n        plugins.push(new UglifyJsPlugin({\n          parallel: true,\n          sourceMap: true,\n          uglifyOptions: {\n            compress: {\n              ecma: 7,\n            },\n          },\n        }))\n      }\n      optimization.minimize = true\n      plugins.push(new LoaderOptionsPlugin({minimize: true}))\n\n      // do not use ModuleConcatenationPlugin for HMR\n      // https://github.com/webpack/webpack-dev-server/issues/949\n      optimization.concatenateModules = true\n    }\n    else {\n      configureDevelopmentPlugins(configurator)\n    }\n\n    if (configurator.env.autoClean !== false) {\n      plugins.push(new WebpackRemoveOldAssetsPlugin(dllManifest))\n    }\n\n    optimization.noEmitOnErrors = true\n\n    const additionalEnvironmentVariables = Object.keys(process.env).filter(it => it.startsWith(\"ELECTRON_WEBPACK_\"))\n    if (additionalEnvironmentVariables.length > 0) {\n      plugins.push(new EnvironmentPlugin(additionalEnvironmentVariables))\n    }\n  }\n}\n\nexport function configureFileLoader(prefix: string, limit = 10 * 1024) {\n  return {\n    limit,\n    name: `${prefix}/[name]--[folder].[ext]`\n  }\n}\n\nfunction isAncestor(file: string, dir: string) {\n  return file.length > dir.length && file[dir.length] === path.sep && file.startsWith(dir)\n}\n\nfunction configureDevelopmentPlugins(configurator: WebpackConfigurator) {\n  const plugins = configurator.plugins\n  configurator.config.optimization!!.namedModules = true\n  plugins.push(new DefinePlugin({\n    __static: `\"${path.join(configurator.projectDir, \"static\").replace(/\\\\/g, \"\\\\\\\\\")}\"`\n  }))\n\n  plugins.push(new HotModuleReplacementPlugin())\n\n  if (configurator.hasDevDependency(\"webpack-build-notifier\")) {\n    const WebpackNotifierPlugin = require(\"webpack-build-notifier\")\n    plugins.push(new WebpackNotifierPlugin({\n      title: `Webpack - ${configurator.type}`,\n      suppressSuccess: \"initial\",\n      sound: false,\n    }))\n  }\n\n  if (configurator.hasDevDependency(\"webpack-notifier\")) {\n    const WebpackNotifierPlugin = require(\"webpack-notifier\")\n    plugins.push(new WebpackNotifierPlugin({title: `Webpack - ${configurator.type}`}))\n  }\n\n  // watch common code\n  let commonSourceDir = configurator.electronWebpackConfiguration.commonSourceDirectory\n  if (commonSourceDir == null) {\n    // not src/common, because it is convenient to just put some code into src to use it\n    commonSourceDir = path.join(configurator.projectDir, \"src\")\n  }\n\n  const alienSourceDir = configurator.getSourceDirectory(configurator.type === \"main\" ? \"renderer\" : \"main\")\n\n  configurator.plugins.push(new WatchFilterPlugin(file => {\n    return file === commonSourceDir || (isAncestor(file, commonSourceDir!!) && (alienSourceDir != null && !file.startsWith(alienSourceDir)))\n  }, require(\"debug\")(`electron-webpack:watch-${configurator.type}`)))\n}\n"],"sourceRoot":""}
